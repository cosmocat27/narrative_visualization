<html>
    <head>
        <style>
            div.chart_title {margin-left: 180px; margin-top: 50px;}
            .line {
                  fill: none;
                  stroke-width: 2px;
            }
        </style>
        
        <script src='https://d3js.org/d3.v5.min.js'></script>
    </head>
    
    <body onload='init()'>
        <h1>CS498 Narrative Visualization Assignment</h1>
        <div class="chart_title">
            <h2 id="title"></h2>
        </div>
        
        <svg width=800 height=800>
        </svg>
        
        <form id="form_breakdown" action="breakdown.html" method="GET">
            <input id="country_field" name="country" value="USA">
            <button type="submit">Submit</button>
        </form>
        
        <script>
            async function init() {
                country = location.search.substring(1).split("&")[0].split("=")[1];
                
                const data = await d3.csv(
                    'Data/' + country + '.csv');
                console.log(data);
                
                const lookup = await d3.csv(
                    'Data/Lookup.csv');
                abbr = lookup.map(function(d,i) {return d.Abbr});
                full = lookup.map(function(d,i) {return d.Full});
                
                country_full = full[abbr.indexOf(country)];
                document.getElementById("title").innerHTML = "Energy usage over time for " + country_full;
                
                years = data.map(function(d,i) {return d.Year});
                
                w = 600;
                h = 600;
                mg_left = 100;
                mg_top = 10;
                maxd = 100;
                var colors = ['DarkOrange','SkyBlue','Ivory','LawnGreen'];
                
                xs = d3.scaleLinear()
                    .domain([Math.min(years), Math.max(years)])
                    .range([0, w]);
                ys = d3.scaleLinear()
                    .domain([0, maxd])
                    .range([h, 0]);
                
                console.log(years);
                console.log(Math.min(years));
                console.log(Math.max(years));
                console.log(xs.domain);
                
                data.columns.slice(1).forEach(function(k, j) {
                     line = d3.line()
                        .x(function(d, i) {return xs(years[i])})
                        .y(function(d) {return ys(d[k])});
                
                    d3.select("svg")
                        .append("g")
                        .attr("transform", "translate("+mg_left+","+mg_top+")")
                        .append("path")
                        .data([data])
                        .attr("d", line)
                        .attr("class", "line")
                        .attr("stroke", colors[j]);
                });
                
                // y axis
                d3.select("svg")
                    .append("g")
                    .attr("transform", "translate("+mg_left+","+mg_top+")")
                    .call(d3.axisLeft(ys));
                
                // x axis
                d3.select("svg")
                    .append("g")
                    .attr("transform", "translate("+mg_left+","+(h+mg_top)+")")
                    .call(d3.axisBottom(xs));
                
                /*
                rect_pos.transition()
                    .duration(2500)
                    .attr("y", function(d) {return mid-ys(d.Nonrenewable)})
                    .attr("height", function(d) {return ys(d.Nonrenewable)});
                
                rect_pos.on("mouseover", function() {
                    d3.select(this).attr("class", "rect_highlight")
                });
                
                rect_pos.on("mouseout", function() {
                    d3.select(this).attr("class", "rect_pos")
                });
                
                rect_pos.on("click", function() {
                    document.getElementById("country_field").value=d3.select(this).data()[0].Country;
                    document.getElementById("form_breakdown").submit();
                });
                
                text_pos = d3.select("svg")
                    .append("g")
                    .attr("transform", "translate("+mg_left+","+mg_top+")")
                    .selectAll("text")
                    .data(data)
                    .enter()
                    .append("text")
                    .attr("x", function(d,i) {return xs(countries[i]) + 45})
                    .attr("y", function(d) {return mid-ys_pos(d.Nonrenewable) - 5})
                
                text_pos.transition()
                    .duration(2500)
                    .text(function(d) {return d.Nonrenewable});
                */
            }
        </script>
        
    </body>
</html>
