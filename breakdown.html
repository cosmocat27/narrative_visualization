<html>
    <head>
        <style>
            path {stroke: black;}
            div.chart_title {margin-left: 180px; margin-top: 50px;}
        </style>
        
        <script src='https://d3js.org/d3.v5.min.js'></script>
    </head>
    
    <body onload='init()'>
        <h1>CS498 Narrative Visualization Assignment</h1>
        <div class="chart_title">
            <h2 id="title"></h2>
        </div>
        
        <svg width=800 height=800>
        </svg>
        
        <form id="form_timeseries" action="time_series.html" method="GET">
            <input id="country_field" type="hidden" name="country" value="">
            <button type="submit">See energy usage over time</button>
        </form>
        
        <button><a href="index.html">Return to overview</a></button>
        
        <script>
            async function init() {
                country = location.search.substring(1).split("&")[0].split("=")[1];
                document.getElementById("country_field").value=country;
                
                const data = await d3.csv(
                    'Data/' + country + '.csv');
                console.log(data);
                
                const lookup = await d3.csv(
                    'Data/Lookup.csv');
                console.log(lookup);
                abbr = lookup.map(function(d,i) {return d.Abbr});
                full = lookup.map(function(d,i) {return d.Full});
                
                country_full = full[abbr.indexOf(country)];
                document.getElementById("title").innerHTML = "Energy source distribution for " + country_full;
                
                w = 600;
                h = 600;
                mg_left = 150;
                mg_top = 20;
                r = 250;
                
                lastrow = data[data.length-1];
                chartdata = []
                data.columns.slice(1).forEach(function(k) {
                    chartdata.push(lastrow[k]);
                });
                console.log(chartdata);
                
                var colors = ['DarkOrange','SkyBlue','Ivory','LawnGreen'];
                var pie = d3.pie();
                var arc = d3.arc().innerRadius(0).outerRadius(r);
                console.log(pie(chartdata));
                
                d3.select("svg")
                    .append("g")
                    .attr("transform", "translate("+(mg_left+r)+","+(mg_top+r)+")")
                    .selectAll("path")
                    .data(pie(chartdata))
                    .enter()
                    .append("path")
                    .attr("d", arc)
                    .attr("fill", function(d, i) {return colors[i]});
                
                var chartdata_cumsum = [];
                chartdata.reduce(function(a,b,i) {return new_array[i] = a+b}, 0);
                console.log(chartdata_cumsum);
                var chartdata_tot = chartdata_cumsum[chartdata_cumsum.length-1];
                var chartdata_pct = chartdata.map(function(d, i) {return [100 * d/chartdata_tot, chartdata_cumsum[i]]});
                console.log(chartdata_pct);
                var x_text = function(p, t) {return 1};
                var y_text = function(p, t) {return 1};
                
                d3.select("svg")
                    .append("g")
                    .attr("transform", "translate("+(mg_left+r)","+(mg_top+r)+")")
                    .selectAll("text")
                    .data(chartdata_pct)
                    .enter()
                    .append("text")
                    .attr("x", function(d,i) {return i * 100})
                    .attr("y", function() {return 500})
                    .text(function(d) {return d[0]});
                

            }
        </script>
        
    </body>
</html>
